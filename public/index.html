<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fridge Fusion AI ì…°í”„ - ìµœì¢… ë°°í¬ ì½”ë“œ (ì•ˆì „ ë²„ì „)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        /* ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 font-sans p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-10 relative">
            <h1 class="text-4xl font-extrabold text-indigo-600">ğŸ¥˜ Fridge Fusion AI ì…°í”„</h1>
            <p class="text-gray-600 mt-2">ë‚¨ì€ ì¬ë£Œë¥¼ ì…ë ¥í•˜ë©´ AIê°€ ë§ì¶¤í˜• ë ˆì‹œí”¼ë¥¼ ì°½ì¡°í•©ë‹ˆë‹¤.</p>
            
            <div class="absolute top-4 right-0 sm:right-auto sm:left-full sm:ml-4 flex items-center space-x-2">
                <span id="user-status" class="text-sm text-gray-600 hidden"></span>
                <button id="auth-button" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">Googleë¡œ ë¡œê·¸ì¸</button>
            </div>
        </header>
        
        <div class="flex justify-center mb-8">
            <button id="generator-tab" class="px-6 py-3 text-lg font-semibold rounded-t-lg transition duration-200 bg-indigo-600 text-white shadow-lg">ë ˆì‹œí”¼ ìƒì„±</button>
            <button id="saved-tab" class="px-6 py-3 text-lg font-semibold rounded-t-lg transition duration-200 bg-white text-gray-600 hover:bg-gray-100">ì €ì¥ëœ ë ˆì‹œí”¼ (<span id="saved-count">0</span>)</button>
        </div>

        <div id="message-box" class="hidden p-4 mb-6 text-sm text-white bg-red-400 rounded-lg shadow-md transition-opacity duration-300" role="alert"></div>
        
        <div id="generator-view">
            <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">ì¬ë£Œ ì…ë ¥ ë° ì¡°ê±´ ì„¤ì •</h2>
                <div class="flex flex-col space-y-4">
                    <div>
                        <label for="ingredients" class="block text-sm font-medium text-gray-700 mb-1">ë‚¨ì€ ì¬ë£Œ ì…ë ¥ (ì½¤ë§ˆë‚˜ ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)</label>
                        <input id="ingredients" type="text" placeholder="ì˜ˆ: ë‹­ê°€ìŠ´ì‚´, ì–‘ë°°ì¶”, í† ë§ˆí† ì†ŒìŠ¤" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"/>
                    </div>
                    
                    <div class="grid sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ë‚œì´ë„ í•„í„°</label>
                            <div id="difficulty-options" class="flex space-x-3 p-3 border border-gray-300 rounded-lg bg-gray-50">
                                <label class="flex items-center cursor-pointer"><input type="radio" name="difficulty" value="ì´ˆê¸‰" checked class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-2 text-gray-700 text-sm">ì´ˆê¸‰</span></label>
                                <label class="flex items-center cursor-pointer"><input type="radio" name="difficulty" value="ì¤‘ê¸‰" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-2 text-gray-700 text-sm">ì¤‘ê¸‰</span></label>
                                <label class="flex items-center cursor-pointer"><input type="radio" name="difficulty" value="ê³ ê¸‰" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-2 text-gray-700 text-sm">ê³ ê¸‰</span></label>
                            </div>
                        </div>
                        
                        <div>
                            <label for="category" class="block text-sm font-medium text-gray-700 mb-1">ìš”ë¦¬ ì¹´í…Œê³ ë¦¬</label>
                            <select id="category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                                <option value="í•œì‹">í•œì‹</option><option value="ì–‘ì‹">ì–‘ì‹</option><option value="ì¼ì‹">ì¼ì‹</option>
                                <option value="ì¤‘ì‹">ì¤‘ì‹</option><option value="í“¨ì „" selected>í“¨ì „</option><option value="ë‹¤ì´ì–´íŠ¸">ë‹¤ì´ì–´íŠ¸</option>
                            </select>
                        </div>
                    </div>

                    <button id="generate-button" class="w-full py-3 bg-indigo-600 text-white font-extrabold rounded-lg shadow-lg hover:bg-indigo-700 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                        âœ¨ ë§ì¶¤ ë ˆì‹œí”¼ ìƒì„±í•˜ê¸°
                    </button>
                </div>
            </div>

            <div id="recipe-output-container" class="space-y-8 hidden"></div>
            
            <div id="initial-message" class="p-8 text-center text-gray-500 bg-white rounded-xl shadow-md">
                <p>ì¬ë£Œë¥¼ ì…ë ¥í•˜ê³  ë§ì¶¤í˜• ë ˆì‹œí”¼ë¥¼ ìƒì„±í•´ ë³´ì„¸ìš”!</p>
            </div>
        </div>

        <div id="saved-view" class="hidden space-y-4">
             <h2 class="text-2xl font-bold text-gray-800 border-b pb-2">ğŸ’¾ ì €ì¥ëœ ë ˆì‹œí”¼ ëª©ë¡ (<span id="saved-list-count">0</span>ê°œ)</h2>
             <div id="saved-recipes-list" class="space-y-6"></div>
             <p class="text-xs text-gray-400 mt-4">ì‚¬ìš©ì ID: <span id="user-id-display">ì¸ì¦ ì¤‘...</span></p>
        </div>
    </div>
    
    <div id="details-modal" class="modal hidden">
        <div id="modal-content" class="modal-content">
            </div>
    </div>

    <script type="module">
        // Firebase SDK ë¡œë“œ
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, query, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // ğŸš¨ğŸš¨ğŸš¨ ë‹¹ì‹ ì˜ ì‹¤ì œ í‚¤ ë° ì„¤ì •ì„ ì—¬ê¸°ì— ì •í™•íˆ ë„£ì–´ì£¼ì„¸ìš”! ğŸš¨ğŸš¨ğŸš¨
        const API_KEY = "AIzaSyATVI-N7RDgANNek521f3VJLB6xzX5kYbI"; // ğŸ‘ˆ Gemini API í‚¤
        const FIREBASE_CONFIG = { // ğŸ‘ˆ Firebase ì„¤ì •
            apiKey: "AIzaSyBcg7Q3ln57jINGlSLKC5EmQQQxAkSPzeQ",
            authDomain: "food-121d1.firebaseapp.com",
            projectId: "food-121d1",
            storageBucket: "food-121d1.firebasestorage.app",
            messagingSenderId: "156738635517",
            appId: "1:156738635517:web:64dc618a7b22e6bad66094",
            measurementId: "G-S1Q441PKL0"   
        };    
        const PLACEHOLDER_KEY = "AIzaSy...ë‹¹ì‹ ì˜ ì‹¤ì œí‚¤...xyz"; 
        
        const GEMINI_MODEL = 'gemini-2.5-flash'; 
        const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
        const IMAGEN_MODEL = 'imagen-3.0-generate-002';
        const IMAGEN_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGEN_MODEL}:predict?key=${API_KEY}`;
        
        let db = null; 
        let auth;
        let userId = null; 
        let currentRecipe = null; 
        let currentRecipeImage = null; 
        let currentSources = []; 
        let chatHistory = []; 
        let isLoading = false;
        
        const GoogleProvider = new GoogleAuthProvider(); 

        // RECIPE_SCHEMA
        const RECIPE_SCHEMA = {
            type: "OBJECT", properties: {title: { type: "STRING"}, difficulty: { type: "STRING"}, time: { type: "STRING"}, tasteProfile: { type: "STRING"}, description: { type: "STRING"}, ingredients: { type: "ARRAY", items: { type: "OBJECT", properties: {name: { type: "STRING" }, quantity: { type: "STRING" }}}}, instructions: { type: "ARRAY", items: { type: "STRING" } }}, required: ["title", "difficulty", "time", "tasteProfile", "description", "ingredients", "instructions"]
        };
        
        // --- UI Elements ---
        let $ingredients, $category, $generateButton, $messageBox, $recipeOutputContainer, $initialMessage, $generatorView, $savedView, $savedCount, $savedListCount, $userIdDisplay, $generatorTab, $savedTab, $detailsModal, $modalContent, $authButton, $userStatus;
        let savedRecipes = [];

        // --- Utility Functions ---
        function showMessage(msg, isError = true) { 
            if (!$messageBox) return; 
            $messageBox.textContent = msg;
            $messageBox.classList.remove('hidden', 'bg-red-400', 'bg-green-400');
            $messageBox.classList.add(isError ? 'bg-red-400' : 'bg-green-400');
            setTimeout(() => { $messageBox.classList.add('hidden'); }, 5000);
        }

        function setLoading(loading, message = 'AI ì…°í”„ê°€ ë ˆì‹œí”¼ë¥¼ ë§Œë“œëŠ” ì¤‘...') { 
            isLoading = loading;
            if (!$generateButton) return; 
            $generateButton.disabled = loading;
            $generateButton.textContent = loading ? message : 'âœ¨ ë§ì¶¤ ë ˆì‹œí”¼ ìƒì„±í•˜ê¸°';
            
            const refineInput = document.querySelector('#refine-form input[name="chatInput"]');
            const refineButton = document.querySelector('#refine-form button[type="submit"]');

            if(refineInput) refineInput.disabled = loading || !currentRecipe;
            if(refineButton) refineButton.disabled = loading || !currentRecipe;
            if(refineInput && loading) refineInput.placeholder = 'AIê°€ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤...';
            if(refineInput && !loading && currentRecipe) refineInput.placeholder = 'ìˆ˜ì • ìš”ì²­ì„ ì…ë ¥í•˜ì„¸ìš”...';
            if(refineButton) refineButton.textContent = loading ? 'ìˆ˜ì • ì¤‘...' : 'ìˆ˜ì • ìš”ì²­';
        }
        
        function getDifficulty() {
            return document.querySelector('input[name="difficulty"]:checked').value;
        }

        // --- Firebase Initialization and Auth ---
        async function initializeFirebaseAndAuth() {
            try {
                if (FIREBASE_CONFIG.projectId) { 
                    const app = initializeApp(FIREBASE_CONFIG);
                    db = getFirestore(app);
                    auth = getAuth(app);
                } else { throw new Error("Firebase CONFIG is missing or invalid. Storage feature disabled."); }
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        $authButton.textContent = 'ë¡œê·¸ì•„ì›ƒ';
                        $userStatus.textContent = `${user.displayName || user.email}ë‹˜`;
                        $userStatus.classList.remove('hidden');
                        $userIdDisplay.textContent = user.uid;
                        setupFirestoreListener(); 
                    } else {
                        userId = null;
                        $authButton.textContent = 'Googleë¡œ ë¡œê·¸ì¸';
                        $userStatus.textContent = '';
                        $userStatus.classList.add('hidden');
                        $userIdDisplay.textContent = 'ë¡œê·¸ì¸ í•„ìš”';
                        setupFirestoreListener(); 
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                userId = null;
                $userIdDisplay.textContent = 'ì €ì¥ ë¹„í™œì„±í™” (ì„¤ì • ì˜¤ë¥˜)';
                showMessage("Firebase ì„¤ì •ì´ ì˜ëª»ë˜ì–´ ë ˆì‹œí”¼ ì €ì¥ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì½˜ì†” í™•ì¸ ìš”ë§.", true);
            }
        }
        
        // --- Auth Handlers ---
        async function handleAuth() {
            if (userId) {
                try {
                    await signOut(auth);
                    showMessage("ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤. ì €ì¥ëœ ë ˆì‹œí”¼ë¥¼ ë³´ë ¤ë©´ ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”.", false);
                } catch (error) {
                    console.error("Logout failed:", error);
                    showMessage("ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", true);
                }
            } else {
                try {
                    await signInWithPopup(auth, GoogleProvider);
                } catch (error) {
                    console.error("Google login failed:", error);
                    showMessage(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${error.code}`, true);
                }
            }
        }

        // --- Firestore Listener ---
        function setupFirestoreListener() {
             if (!userId) {
                 savedRecipes = [];
                 $savedCount.textContent = 0;
                 $savedListCount.textContent = 0;
                 if (!$generatorView.classList.contains('hidden')) { renderSavedRecipes(); }
                 return;
             }
            
             const recipeCollectionPath = `artifacts/${FIREBASE_CONFIG.appId || 'default'}/users/${userId}/savedRecipes`;
             const q = query(collection(db, recipeCollectionPath));
             onSnapshot(q, (snapshot) => {
                 savedRecipes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 $savedCount.textContent = savedRecipes.length;
                 $savedListCount.textContent = savedRecipes.length;
                 if (!$generatorView.classList.contains('hidden')) { renderSavedRecipes(); }
             }, (error) => { console.error("Error fetching saved recipes:", error); });
        }
        
        // --- Image Generation Function (ìƒëµ) ---
        async function generateRecipeImage(prompt) { /* ... */ 
             // API í‚¤ ë…¸ì¶œ ë¬¸ì œ ë° ë³µì¡ì„± ë•Œë¬¸ì—, í˜„ì¬ëŠ” ì´ë¯¸ì§€ ìƒì„± í˜¸ì¶œì„ ì£¼ì„ ì²˜ë¦¬í•˜ê³  PLACEHOLDERë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.
             // ì‹¤ì œ ë°°í¬ì—ì„œëŠ” ì´ í•¨ìˆ˜ë¥¼ ì™„ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
             return "https://via.placeholder.com/300?text=Recipe+Image+Placeholder";
        }

        // --- Core Function: Combined Generation (API ì§ì ‘ í˜¸ì¶œ) ---
        async function startGeneration(currentIngredients, currentDifficulty, currentCategory, chatMessage = null) {
            if (isLoading) return;
            
            if (API_KEY.length < 30) { 
                showMessage("ğŸš¨ API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í‚¤ ê°’ì„ í™•ì¸í•´ì£¼ì„¸ìš”.", true);
                return; 
            }
            
            const isRefining = !!chatMessage;
            if (!isRefining) { 
                currentRecipe = null; currentRecipeImage = null; currentSources = []; chatHistory = []; 
            }

            setLoading(true, isRefining ? 'AI ì…°í”„ê°€ ë ˆì‹œí”¼ë¥¼ ìˆ˜ì •í•˜ê³  ìˆìŠµë‹ˆë‹¤...' : 'AI ì…°í”„ê°€ ë‹¹ì‹ ì„ ìœ„í•œ ë ˆì‹œí”¼ì™€ ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ê³  ìˆìŠµë‹ˆë‹¤...');

            const basePrompt = `ë‹¤ìŒ ì¬ë£Œ '${currentIngredients}'ë¥¼ **ì˜¤ì§ ì‚¬ìš©í•˜ì—¬** ë‚œì´ë„ '${currentDifficulty}'ì— ë§ê³ , '${currentCategory}' ì¹´í…Œê³ ë¦¬ ë‚´ì—ì„œ ì¡°ë¦¬ ì‹œê°„ 10ë¶„ì—ì„œ 20ë¶„ ì´ë‚´ì˜ ë ˆì‹œí”¼ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”. ëª¨ë“  ì‘ë‹µì€ ìš”ì²­ëœ JSON ìŠ¤í‚¤ë§ˆë¥¼ ë”°ë¼ì•¼ í•˜ë©°, ì‘ë‹µ ì–¸ì–´ëŠ” í•œêµ­ì–´ë¡œ ì‘ì„±í•´ ì£¼ì„¸ìš”.`;
            const userPromptPart = { text: chatMessage || basePrompt };
            const contentsToSend = isRefining ? [...chatHistory, { role: "user", parts: [userPromptPart] }] : [{ role: "user", parts: [userPromptPart] }];

            try {
                const payload = {
                    contents: contentsToSend,
                    generationConfig: { 
                        responseMimeType: "application/json", 
                        responseSchema: RECIPE_SCHEMA 
                    },
                    systemInstruction: { parts: [{ text: "ë‹¹ì‹ ì€ ì„¸ê³„ì ì¸ ì…°í”„ AIì…ë‹ˆë‹¤. ì˜¤ì§ ì‚¬ìš©ìê°€ ì œê³µí•œ ì¬ë£Œë§Œ ì‚¬ìš©í•˜ì—¬ ì •í™•íˆ JSON í˜•ì‹ì— ë§ì¶° ë ˆì‹œí”¼ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤." }] },
                };
                
                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Gemini API Error Response:", errorText);
                    throw new Error(`Gemini API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}. ì½˜ì†”ì˜ ìƒì„¸ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0]; 
                const jsonText = candidate?.content?.parts?.[0]?.text;
                
                if (!jsonText || jsonText.trim().length === 0) {
                     throw new Error('APIê°€ ì‘ë‹µí–ˆìœ¼ë‚˜ ë ˆì‹œí”¼ ë°ì´í„°(JSON)ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.');
                }

                let parsedRecipe;
                try {
                    parsedRecipe = JSON.parse(jsonText);
                } catch (e) {
                    throw new Error('API ì‘ë‹µì´ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                }

                currentRecipe = parsedRecipe;
                currentRecipeImage = await generateRecipeImage(currentRecipe.title); 
                
                renderRecipe();
                showMessage("ğŸ‰ ë ˆì‹œí”¼ê°€ ì„±ê³µì ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!", false);

            } catch (error) {
                console.error('Error in generation process:', error);
                showMessage(`ë ˆì‹œí”¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}.`, true);
            } finally {
                setLoading(false);
            }
        }
        
        // --- Firestore CRUD Functions ---
        async function saveCurrentRecipe() { 
            if (!currentRecipe) { 
                showMessage("ì €ì¥í•  ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë ˆì‹œí”¼ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.", true); 
                return; 
            }
            
            // ğŸš¨ğŸš¨ğŸš¨ ë¡œê·¸ì¸ ìƒíƒœê°€ ì•„ë‹ˆë©´ ì¦‰ì‹œ ë¡œê·¸ì¸ íŒì—…ì„ ë„ì›ë‹ˆë‹¤. ğŸš¨ğŸš¨ğŸš¨
            if (!userId) { 
                showMessage("ğŸš¨ ì €ì¥ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ Google ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ ì°½ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.", true); 
                await handleAuth();
                return;
            }
            
            if (!db) { showMessage("ğŸš¨ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì˜¤ë¥˜ë¡œ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", true); return; }
            
            try {
                const recipeToSave = { ...currentRecipe, createdAt: new Date().toISOString(), userId: userId, ingredientsInput: $ingredients.value, category: $category.value, recipeImage: currentRecipeImage || null, sources: currentSources };
                const recipeCollectionPath = `artifacts/${FIREBASE_CONFIG.appId || 'default'}/users/${userId}/savedRecipes`;
                await addDoc(collection(db, recipeCollectionPath), recipeToSave);
                showMessage(`ë ˆì‹œí”¼ '${currentRecipe.title}'ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!`, false);
            } catch (error) { 
                console.error("Error saving recipe:", error); 
                showMessage("ë ˆì‹œí”¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Firestore ê·œì¹™ì´ë‚˜ ì½˜ì†” ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.", true); 
            }
        }

        async function deleteSavedRecipe(recipeId, title) {
            if (!userId || !db) return;
            try {
                const docRef = doc(db, `artifacts/${FIREBASE_CONFIG.appId || 'default'}/users/${userId}/savedRecipes`, recipeId);
                await deleteDoc(docRef);
                renderSavedRecipes(); 
                showMessage(`ë ˆì‹œí”¼ '${title}'ì´(ê°€) ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, false);
            } catch (error) {
                console.error("Error deleting recipe:", error);
                showMessage("ë ˆì‹œí”¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", true);
            }
        }
        
        // --- Saved Recipe Details Viewer ---
        function viewSavedRecipeDetails(recipeId) {
            const recipe = savedRecipes.find(r => r.id === recipeId);
            if (!recipe) return;

            const tasteKeywords = recipe.tasteProfile ? recipe.tasteProfile.split(',').map(s => s.trim()) : [];

            const detailsHTML = `
                <button onclick="document.getElementById('details-modal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-500 hover:text-gray-900 text-2xl font-bold">
                    &times;
                </button>
                <h2 class="text-3xl font-extrabold text-indigo-700 border-b pb-2 mb-4">${recipe.title || 'ì œëª© ì—†ìŒ'}</h2>
                
                <div class="text-sm mb-4 p-3 bg-indigo-50 rounded-lg">
                    <div class="flex justify-between items-center pb-2 border-b border-indigo-200 mb-2">
                        <span class="font-semibold text-gray-700">â° ì¡°ë¦¬ ì‹œê°„: ${recipe.time}</span>
                        <span class="font-semibold text-gray-700">â­ ë‚œì´ë„: ${recipe.difficulty}</span>
                    </div>
                    
                    <div class="flex flex-wrap items-center pt-2">
                        <span class="font-bold text-gray-700 mr-2">ğŸ˜‹ ì˜ˆìƒ ë§›:</span>
                        ${tasteKeywords.map(tag => `<span class="bg-yellow-200 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full shadow-sm">${tag}</span>`).join('')}
                    </div>
                </div>
                
                <p class="text-gray-600 italic mb-6 border-l-4 border-indigo-400 pl-3">"${recipe.description}"</p>

                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center"><span class="text-indigo-500 mr-2">ğŸ´</span> í•„ìˆ˜ ì¬ë£Œ</h3>
                        <ul class="list-disc list-inside space-y-1 text-gray-700 pl-2">
                            ${recipe.ingredients && recipe.ingredients.map(ing => `<li class="hover:bg-gray-50 p-1 rounded transition"><span class="font-medium">${ing.name}</span>: ${ing.quantity}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center"><span class="text-green-500 mr-2">âœ¨</span> ì…ë ¥ ì¬ë£Œ</h3>
                        <p class="text-sm text-gray-600 mb-2">(ë ˆì‹œí”¼ ìƒì„± ì‹œ ì‚¬ìš©í•œ ì¬ë£Œ)</p>
                        <ul class="list-disc list-inside space-y-1 text-gray-700 pl-2">
                            <li class="hover:bg-green-50 p-1 rounded transition">${recipe.ingredientsInput || 'N/A'}</li>
                        </ul>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center"><span class="text-red-500 mr-2">ğŸ”¥</span> ì¡°ë¦¬ ìˆœì„œ</h3>
                    <ol class="space-y-4">
                        ${recipe.instructions && recipe.instructions.map((step, index) => `<li class="flex items-start"><span class="flex-shrink-0 w-8 h-8 flex items-center justify-center bg-indigo-500 text-white rounded-full font-bold text-sm shadow-md">${index + 1}</span><p class="ml-3 pt-1 text-gray-700">${step}</p></li>`).join('')}
                    </ol>
                </div>
            `;
            
            $modalContent.innerHTML = detailsHTML;
            $detailsModal.classList.remove('hidden');
        }

        // --- Rendering Functions ---
        function renderRecipe() { 
             if (!currentRecipe) { $recipeOutputContainer.innerHTML = ''; return; }
             
             const recipe = currentRecipe;
             const tasteKeywords = recipe.tasteProfile ? recipe.tasteProfile.split(',').map(s => s.trim()) : [];
             
             let ingredientsList = recipe.ingredients.map(i => `<li class="flex items-start"><span class="text-indigo-600 mr-2">â€¢</span>${i.name} (${i.quantity})</li>`).join('');
             let instructionsList = recipe.instructions.map((i, idx) => `<li class="mb-3"><span class="font-bold text-indigo-600">${idx + 1}.</span> ${i}</li>`).join('');


             const recipeCardHTML = `
                <div class="recipe-card bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-6 transition-all duration-300">
                    <h2 class="text-3xl font-extrabold text-indigo-700 border-b pb-2 mb-4">${recipe.title || 'ì œëª© ì—†ìŒ'}</h2>
                    
                    <div class="text-sm mb-4 p-3 bg-indigo-50 rounded-lg">
                        <div class="flex justify-between items-center pb-2 border-b border-indigo-200 mb-2">
                            <span class="font-semibold text-gray-700">â° ì¡°ë¦¬ ì‹œê°„: ${recipe.time}</span>
                            <span class="font-semibold text-gray-700">â­ ë‚œì´ë„: ${recipe.difficulty}</span>
                        </div>
                        
                        <div class="flex flex-wrap items-center pt-2">
                            <span class="font-bold text-gray-700 mr-2">ğŸ˜‹ ì˜ˆìƒ ë§›:</span>
                            ${tasteKeywords.map(tag => `<span class="bg-yellow-200 text-yellow-800 text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full shadow-sm">${tag}</span>`).join('')}
                        </div>

                        <button id="save-recipe-button" class="mt-3 flex items-center text-sm font-medium text-white bg-green-500 hover:bg-green-600 transition px-3 py-1 rounded-full shadow-md w-full justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3-7 3V5z" /></svg>
                            ë ˆì‹œí”¼ ì €ì¥
                        </button>
                    </div>
                    
                    <p class="text-gray-600 italic mb-6 border-l-4 border-indigo-400 pl-3">"${recipe.description}"</p>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center"><span class="text-indigo-500 mr-2">ğŸ´</span> í•„ìˆ˜ ì¬ë£Œ</h3>
                            <ul class="list-none space-y-2 text-gray-700 pl-2">
                                ${ingredientsList}
                            </ul>
                        </div>
                        
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center"><span class="text-green-500 mr-2">âœ¨</span> ì…ë ¥ ì¬ë£Œ</h3>
                            <p class="text-sm text-gray-600 mb-2">(ì´ ë ˆì‹œí”¼ ìƒì„± ì‹œ ì‚¬ìš©í•œ ì¬ë£Œ)</p>
                            <ul class="list-none space-y-2 text-gray-700 pl-2">
                                <li class="hover:bg-green-50 p-1 rounded transition">${$ingredients.value || 'N/A'}</li>
                            </ul>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center"><span class="text-red-500 mr-2">ğŸ”¥</span> ì¡°ë¦¬ ìˆœì„œ</h3>
                        <ol class="list-decimal pl-5 space-y-3 text-gray-700">
                            ${instructionsList}
                        </ol>
                    </div>
                </div>
            `;
            const refinementChatHTML = `
                <div id="refinement-chat-container" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                    <form id="refine-form" class="flex space-x-3">
                        <input name="chatInput" type="text" placeholder="${isLoading ? 'AIê°€ ì‘ì—… ì¤‘ì…ë‹ˆë‹¤...' : 'ìˆ˜ì • ìš”ì²­ì„ ì…ë ¥í•˜ì„¸ìš”...'}" disabled="${isLoading ? 'true' : ''}" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-50"/>
                        <button type="submit" disabled="${isLoading ? 'true' : ''}" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 disabled:opacity-50">${isLoading ? 'ìˆ˜ì • ì¤‘...' : 'ìˆ˜ì • ìš”ì²­'}</button>
                    </form>
                </div>
            `;
            $recipeOutputContainer.innerHTML = recipeCardHTML + refinementChatHTML;
            document.getElementById('save-recipe-button').addEventListener('click', saveCurrentRecipe);
            document.getElementById('refine-form').addEventListener('submit', handleRefine);
            $recipeOutputContainer.classList.remove('hidden');
            $initialMessage.classList.add('hidden');
        }
        
        function renderSavedRecipes() {
            const $savedRecipesList = document.getElementById('saved-recipes-list');
            if (savedRecipes.length === 0) {
                 $savedRecipesList.innerHTML = `<p class="text-gray-500 p-8 text-center bg-white rounded-xl shadow">ì €ì¥ëœ ë ˆì‹œí”¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë ˆì‹œí”¼ ìƒì„± í›„ 'ë ˆì‹œí”¼ ì €ì¥' ë²„íŠ¼ì„ ëˆŒëŸ¬ë³´ì„¸ìš”!</p>`;
                 return;
            }
            
            $savedRecipesList.innerHTML = `
                <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    ${savedRecipes.map(r => `
                        <div data-id="${r.id}" class="recipe-card-preview bg-white p-5 rounded-xl shadow-lg border-l-4 border-indigo-500 hover:shadow-xl hover:cursor-pointer transition duration-200">
                            <h3 class="text-xl font-bold text-gray-800 truncate mb-2">${r.title}</h3>
                            <p class="text-sm text-gray-600 mb-3 line-clamp-2">${r.description}</p>
                            <div class="flex justify-between text-xs text-gray-500 mb-3">
                                <span>â° ${r.time}</span>
                                <span>â­ ${r.difficulty}</span>
                            </div>
                            <p class="text-xs text-indigo-500 italic mb-3">ì…ë ¥ ì¬ë£Œ: ${r.ingredientsInput || 'N/A'}</p>
                            
                            <button data-id="${r.id}" data-title="${r.title}" class="delete-button w-full py-2 text-sm text-white bg-red-500 hover:bg-red-600 rounded-lg transition mt-3">
                                ì‚­ì œí•˜ê¸°
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    const id = e.target.getAttribute('data-id');
                    const title = e.target.getAttribute('data-title');
                    deleteSavedRecipe(id, title);
                });
            });
            
            document.querySelectorAll('.recipe-card-preview').forEach(card => {
                card.addEventListener('click', (e) => {
                    const id = card.getAttribute('data-id');
                    viewSavedRecipeDetails(id);
                });
            });
        }


        // --- Event Handlers ---
        function handleGenerateClick() {
            if (isLoading) return;
            const ingredients = $ingredients.value.trim();
            if (!ingredients) { showMessage("ì¬ë£Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
            chatHistory = []; 
            startGeneration(ingredients, getDifficulty(), $category.value);
        }

        function handleRefine(e) { /* ... */ }
        
        function handleTabClick(mode) { 
            const isGenerator = mode === 'generator';
            
            $generatorTab.classList.toggle('bg-indigo-600', isGenerator);
            $generatorTab.classList.toggle('text-white', isGenerator);
            $generatorTab.classList.toggle('bg-white', !isGenerator);
            $generatorTab.classList.toggle('text-gray-600', !isGenerator);

            $savedTab.classList.toggle('bg-indigo-600', !isGenerator);
            $savedTab.classList.toggle('text-white', !isGenerator);
            $savedTab.classList.toggle('bg-white', isGenerator);
            $savedTab.classList.toggle('text-gray-600', isGenerator);
            
            $generatorView.classList.toggle('hidden', !isGenerator);
            $savedView.classList.toggle('hidden', isGenerator);

            if (!isGenerator) {
                renderSavedRecipes();
            }
        }

        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // ğŸš¨ğŸš¨ğŸš¨ UI ìš”ì†Œ ì°¸ì¡°ë¥¼ DOMContentLoaded ë‚´ë¶€ì—ì„œ ìˆ˜í–‰ ğŸš¨ğŸš¨ğŸš¨
            $ingredients = document.getElementById('ingredients');
            $category = document.getElementById('category');
            $generateButton = document.getElementById('generate-button');
            $messageBox = document.getElementById('message-box');
            $recipeOutputContainer = document.getElementById('recipe-output-container');
            $initialMessage = document.getElementById('initial-message');
            $generatorView = document.getElementById('generator-view');
            $savedView = document.getElementById('saved-view');
            $savedCount = document.getElementById('saved-count');
            $savedListCount = document.getElementById('saved-list-count');
            $userIdDisplay = document.getElementById('user-id-display');
            $generatorTab = document.getElementById('generator-tab');
            $savedTab = document.getElementById('saved-tab');
            $detailsModal = document.getElementById('details-modal');
            $modalContent = document.getElementById('modal-content');
            $authButton = document.getElementById('auth-button'); 
            $userStatus = document.getElementById('user-status'); 

            // Firebase ë° ì¸ì¦ ì‹œì‘
            initializeFirebaseAndAuth(); 
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.getElementById('generator-tab').addEventListener('click', () => handleTabClick('generator'));
            document.getElementById('saved-tab').addEventListener('click', () => handleTabClick('saved'));
            $generateButton.addEventListener('click', handleGenerateClick);
            $authButton.addEventListener('click', handleAuth);
            
            handleTabClick('generator');
        });

    </script>
</body>
</html>